<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Spese di Viaggio</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for trash icon and lock icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Colore di fallback */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            /* Immagine di sfondo per l'intero body */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Sri_Lanka_map_with_provinces.svg/1200px-Sri_Lanka_map_with_provinces.svg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Rende lo sfondo fisso allo scroll */
            position: relative; /* Necessario per il pseudo-elemento ::before */
            z-index: 0; /* Assicura che il body sia alla base */
        }

        /* Overlay e effetto sfocato per l'immagine di sfondo */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8); /* Overlay bianco semi-trasparente */
            filter: blur(2px); /* Applica la sfocatura al pseudo-elemento */
            z-index: -1; /* Posizionalo dietro il contenuto principale ma sopra l'immagine di sfondo del body */
        }

        /* Stili per il modale */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 24rem;
        }
        /* Stili per i messaggi */
        .message {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.875rem; /* sm */
        }
        .message.success {
            color: #16a34a; /* green-600 */
        }
        .message.error {
            color: #dc2626; /* red-600 */
        }
        /* Stili per il pulsante di caricamento */
        .loading-button {
            background-color: #6366f1; /* indigo-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .delete-icon {
            color: #ef4444; /* red-500 */
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s ease-in-out;
        }
        .delete-icon:hover {
            color: #dc2626; /* red-600 */
        }
        .edit-icon {
            color: #2563eb; /* blue-600 */
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s ease-in-out;
            margin-right: 0.5rem; /* Spazio tra edit e delete */
        }
        .edit-icon:hover {
            color: #1d4ed8; /* blue-700 */
        }
        .participant-checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .participant-checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .summary-positive {
            color: #16a34a; /* green-600 */
        }
        .summary-negative {
            color: #dc2626; /* red-600 */
        }
        /* Stile per la schermata principale, ora con background chiaro e z-index */
        #main-screen {
            background-color: rgba(255, 255, 255, 0.9); /* Sfondo chiaro per il contenuto */
            position: relative; /* Assicura che il contenuto sia sopra l'overlay del body */
            z-index: 3; /* Più alto del body::before */
        }
        /* Stili per il testo della differenza totale */
        .overall-balance-text-positive {
            color: #047857; /* green-800 */
        }
        .overall-balance-text-negative {
            color: #b91c1c; /* red-800 */
        }
        .overall-balance-text-zero {
            color: #000000; /* black */
        }
        /* Stili per il pop-up di notifica */
        #notification-popup {
            opacity: 0;
            pointer-events: none; /* Allows clicks to pass through when hidden */
        }
        #notification-popup.show {
            opacity: 1;
            pointer-events: auto;
        }
        #notification-popup.success {
            background-color: #10b981; /* emerald-500 */
        }
        #notification-popup.error {
            background-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body>

    <div id="app-container" class="w-full max-w-md">
        <!-- Contenuto dell'app verrà iniettato qui dal JavaScript -->
        <div id="main-screen" class="bg-white p-8 rounded-lg shadow-xl text-center max-w-md w-full mx-auto">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Gestione Spese di Viaggio</h1>
            <p class="text-gray-600 mb-8" id="initial-loading-message">
                Caricamento applicazione...
            </p>
            <div class="space-y-4">
                <button id="add-income-btn" class="w-full py-3 px-6 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105" disabled>
                    Gestisci Entrate <i class="fas fa-lock ml-2"></i>
                </button>
                <button id="add-expense-btn" class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105" disabled>
                    Inserisci Nuova Spesa <i class="fas fa-lock ml-2"></i>
                </button>
                <button id="view-expenses-btn" class="w-full py-3 px-6 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105" disabled>
                    Vedi Totale Spese
                </button>
                <button id="view-single-participant-expenses-btn" class="w-full py-3 px-6 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105" disabled>
                    Vedi Spese Singole
                </button>
            </div>
            <p id="user-id-display" class="mt-8 text-xs text-gray-500 hidden">
                ID Utente: <span id="actual-user-id" class="font-mono break-all"></span>
            </p>
        </div>

        <div id="add-expense-form-container" class="hidden p-6 bg-white rounded-lg shadow-xl max-w-md mx-auto my-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="expense-form-title">Aggiungi Nuova Spesa</h2>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id-to-edit" value="">
                <div>
                    <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                    <input
                        type="date"
                        id="expense-date"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required
                    />
                </div>
                <div>
                    <label for="expense-cost" class="block text-sm font-medium text-gray-700 mb-1">Costo Spesa (LKR):</label>
                    <input
                        type="number"
                        id="expense-cost"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Es. 1.500"
                        step="1"
                        required
                    />
                </div>
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione:</label>
                    <textarea
                        id="expense-description"
                        rows="3"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Es. Biglietto aereo per Colombo, Pasto al ristorante"
                        required
                    ></textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Partecipanti alla Spesa:</label>
                    <div class="mb-2">
                        <input type="radio" id="all-participants-radio" name="participantSelection" value="all" checked>
                        <label for="all-participants-radio" class="text-gray-800 text-sm font-medium">Tutti i partecipanti</label>
                    </div>
                    <div class="mb-2">
                        <input type="radio" id="exclude-participants-radio" name="participantSelection" value="exclude">
                        <label for="exclude-participants-radio" class="text-gray-800 text-sm font-medium">Escludi partecipanti specifici</label>
                    </div>

                    <div id="individual-participants-selection" class="border border-gray-300 rounded-md p-3 max-h-40 overflow-y-auto bg-gray-50 mt-2 hidden">
                        <p id="loading-expense-participants" class="text-gray-500 text-sm">Caricamento partecipanti...</p>
                        <p id="no-expense-participants" class="text-gray-500 text-sm hidden">Nessun partecipante registrato. Aggiungine in "Gestisci Entrate".</p>
                        <!-- Individual checkboxes will be inserted here -->
                    </div>
                </div>
                <button
                    type="submit"
                    id="submit-expense-btn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Aggiungi Spesa
                </button>
            </form>
            <p id="expense-message" class="message"></p>
            <div class="mt-6 flex justify-between space-x-2">
                <button
                    id="back-to-main-from-add"
                    class="w-1/2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Torna alla schermata principale
                </button>
                <button
                    id="add-another-expense-btn"
                    class="w-1/2 py-2 px-4 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                    Aggiungi un'altra spesa
                </button>
            </div>
        </div>

        <div id="view-expenses-list-container" class="hidden p-6 bg-white rounded-lg shadow-xl max-w-3xl mx-auto my-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Riepilogo Spese e Entrate</h2>
            <div id="summary-section" class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Riepilogo Partecipanti</h3>
                <p class="text-center text-gray-600" id="loading-summary">Calcolo riepilogo...</p>
                <p class="text-center text-gray-600 hidden" id="no-summary-data">Nessun dato per il riepilogo. Aggiungi spese e entrate.</p>
                <div id="summary-table-wrapper" class="overflow-x-auto hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                                    Partecipante
                                </th>
                                <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">
                                    Entrate (LKR)
                                </th>
                                <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">
                                    Spese (LKR)
                                </th>
                                <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">
                                    Differenza (LKR)
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="summary-table-body">
                            <!-- Summary rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-right text-lg font-bold text-gray-800 mt-4 hidden" id="total-income-summary-display">
                    Totale Entrate Registrate: <span id="total-income-summary-value">0</span> LKR
                </div>
            </div>

            <!-- Nuova sezione: Differenza Totale Entrate e Spese -->
            <div id="overall-difference-section" class="mb-8 border border-gray-200 rounded-lg p-4">
                <h3 class="text-xl font-bold text-center mb-2 text-gray-800">Differenza Totale</h3>
                <p class="text-center text-2xl">
                    <span id="overall-balance-value" class="font-bold">0</span> LKR
                </p>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Dettaglio Spese</h2>
            <div id="filter-section" class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Filtra Spese</h3>
                <div class="space-y-3">
                    <div>
                        <label for="filter-date-start" class="block text-sm font-medium text-gray-700 mb-1">Data Inizio:</label>
                        <input type="date" id="filter-date-start" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="filter-date-end" class="block text-sm font-medium text-gray-700 mb-1">Data Fine:</label>
                        <input type="date" id="filter-date-end" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="filter-description-input" class="block text-sm font-medium text-gray-700 mb-1">Descrizione:</label>
                        <input type="text" id="filter-description-input" placeholder="Cerca descrizione..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="flex space-x-2">
                        <button id="apply-filters-btn" class="w-1/2 py-2 px-4 bg-blue-500 text-white font-semibold rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">Applica Filtri</button>
                        <button id="reset-filters-btn" class="w-1/2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Reset Filtri</button>
                    </div>
                </div>
            </div>
            <p class="text-right text-lg font-bold text-gray-800 mb-4 hidden" id="total-cost-display-top">
                Totale Generale Spese: <span id="total-cost-value-top">0</span> LKR
            </p>
            <p class="text-center text-gray-600" id="loading-expenses">Caricamento spese...</p>
            <p class="text-center text-gray-600 hidden" id="no-expenses">Nessuna spesa registrata.</p>
            <div class="overflow-x-auto rounded-lg shadow-md mb-6 hidden" id="expenses-table-wrapper">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Data
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Costo (LKR)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Descrizione
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Partecipanti
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Azione
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="expenses-table-body">
                        <!-- Righe delle spese -->
                    </tbody>
                </table>
            </div>
            <button
                id="export-data-btn"
                class="w-full py-3 px-6 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 mt-6"
            >
                Esporta Dati (CSV)
            </button>
            <button
                id="back-to-main-from-view"
                class="mt-3 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Torna alla schermata principale
            </button>
        </div>

        <!-- Nuova sezione Entrate -->
        <div id="income-management-container" class="hidden p-6 bg-white rounded-lg shadow-xl max-w-md mx-auto my-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestisci Entrate</h2>

            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Aggiungi Nuova Entrata</h3>
            <form id="income-entry-form" class="space-y-4 mb-6">
                <div>
                    <label for="income-participant-name" class="block text-sm font-medium text-gray-700 mb-1">Nome Partecipante:</label>
                    <input
                        type="text"
                        id="income-participant-name"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                        placeholder="Es. Mario Rossi"
                        required
                    />
                </div>
                <div>
                    <label for="income-amount" class="block text-sm font-medium text-gray-700 mb-1">Importo Versato (LKR):</label>
                    <input
                        type="number"
                        id="income-amount"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                        placeholder="Es. 5.000"
                        step="1"
                        required
                    />
                </div>
                <div>
                    <label for="income-description" class="block text-sm font-medium text-gray-700 mb-1">Descrizione Entrata (Opzionale):</label>
                    <textarea
                        id="income-description"
                        rows="2"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                        placeholder="Es. Fondo comune per il viaggio"
                    ></textarea>
                </div>
                <button
                    type="submit"
                    id="save-single-income-btn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Salva Entrata
                </button>
            </form>
            <p id="income-message" class="message"></p>

            <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-3 text-center">Riepilogo Partecipanti:</h3>
            <p class="text-center text-gray-600" id="loading-income-summary">Calcolo riepilogo...</p>
            <p class="text-center text-gray-600 hidden" id="no-income-summary-data">Nessun dato per il riepilogo. Aggiungi spese e entrate.</p>
            <div id="income-summary-table-wrapper" class="overflow-x-auto hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                                Partecipante
                            </th>
                            <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">
                                Entrate (LKR)
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="income-summary-table-body">
                        <!-- Summary rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="text-right text-lg font-bold text-gray-800 mt-4 hidden" id="total-income-section-display">
                Totale Entrate Registrate: <span id="total-income-section-value">0</span> LKR
            </div>


            <h3 class="text-lg font-semibold text-gray-800 mt-8 mb-3 text-center">Entrate Registrate:</h3>
            <div class="overflow-x-auto rounded-lg shadow-md mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Data
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Totale (LKR)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Descrizione
                            </th>
                             <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Azione
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="incomes-table-body">
                        <tr id="loading-incomes-row"><td colspan="4" class="px-6 py-4 text-center text-gray-600">Caricamento entrate...</td></tr>
                        <tr id="no-incomes-row" class="hidden"><td colspan="4" class="px-6 py-4 text-center text-gray-600">Nessuna entrata registrata.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6">
                <button
                    id="delete-all-data-btn"
                    class="w-full py-3 px-6 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Cancella tutti i dati
                </button>
            </div>

            <button
                id="back-to-main-from-income"
                class="mt-6 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Torna alla schermata principale
            </button>
        </div>

        <!-- Nuova sezione Vedi Spese Singole -->
        <div id="view-single-participant-expenses-container" class="hidden p-6 bg-white rounded-lg shadow-xl max-w-3xl mx-auto my-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Spese per Partecipante</h2>

            <div class="mb-6">
                <label for="single-participant-select" class="block text-sm font-medium text-gray-700 mb-1">Seleziona Partecipante:</label>
                <select id="single-participant-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">-- Seleziona un partecipante --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Riepilogo per il singolo partecipante -->
            <div id="single-participant-summary-section" class="mb-8 border border-gray-200 rounded-lg p-4 hidden">
                <h3 class="text-xl font-bold text-center mb-2 text-gray-800">Riepilogo per <span id="single-participant-summary-name"></span></h3>
                <p class="text-center text-lg text-gray-800">
                    Entrate: <span id="single-participant-income-value" class="font-bold">0</span> LKR
                </p>
                <p class="text-center text-lg text-gray-800">
                    Spese: <span id="single-participant-expense-value" class="font-bold">0</span> LKR
                </p>
                <p class="text-center text-2xl">
                    Differenza: <span id="single-participant-balance-value" class="font-bold">0</span> LKR
                </p>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Dettaglio Spese di <span id="selected-participant-name"></span></h3>
            <p class="text-right text-lg font-bold text-gray-800 mb-4 hidden" id="total-single-participant-cost-display">
                Totale Spese: <span id="total-single-participant-cost-value">0</span> LKR
            </p>
            <p class="text-center text-gray-600" id="loading-single-expenses">Caricamento spese...</p>
            <p class="text-center text-gray-600 hidden" id="no-single-expenses">Nessuna spesa trovata per questo partecipante.</p>
            <div class="overflow-x-auto rounded-lg shadow-md mb-6 hidden" id="single-participant-expenses-table-wrapper">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Data
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Costo Totale (LKR)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Quota (LKR)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Descrizione
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="single-participant-expenses-table-body">
                        <!-- Righe delle spese -->
                    </tbody>
                </table>
            </div>

            <button
                id="back-to-main-from-single-expenses"
                class="mt-6 w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Torna alla schermata principale
            </button>
        </div>
    </div>

    <!-- Modale Password -->
    <div id="password-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4 text-center" id="password-modal-title">Inserisci Password</h3>
            <p class="text-gray-600 text-sm mb-4 text-center" id="password-modal-message">Per procedere, inserisci la password.</p>
            <input
                type="password"
                id="password-input"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="Password"
            />
            <p id="password-error" class="text-red-600 text-sm mt-2 text-center hidden"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button
                    id="cancel-password-btn"
                    class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Annulla
                </button>
                <button
                    id="confirm-password-btn"
                    class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Conferma
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Dettagli Personalizzato -->
    <div id="custom-details-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="custom-details-modal-title">Dettagli</h3>
            <div id="custom-details-modal-content" class="text-gray-700 text-sm mb-4 whitespace-pre-wrap"></div>
            <div class="mt-6 flex justify-end">
                <button
                    id="close-custom-details-modal-btn"
                    class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Pop-up -->
    <div id="notification-popup" class="fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white text-center text-lg font-semibold hidden transition-opacity duration-500 ease-in-out z-[1001]">
        <!-- Message will be inserted here -->
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, Timestamp, deleteDoc, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **************************************************************************************************
        // *** ATTENZIONE: INSERISCI QUI LA TUA CONFIGURAZIONE FIREBASE PERSONALE!                     ***
        // *** Questa configurazione è ESSENZIALE per far funzionare l'app al di fuori del Canvas.    ***
        // *** Puoi trovarla nella console Firebase del tuo progetto, nella sezione "Impostazioni Progetto".***
        // *** Assicurati di SOSTITUIRE TUTTI i valori placeholder (es. "YOUR_API_KEY") con i tuoi dati reali.***
        // **************************************************************************************************
        const firebaseConfig = {
          apiKey: "AIzaSyCgR3_zS2BYT4bMKZ4eajOu_K80hlb0_aI",
          authDomain: "speseviaggio.firebaseapp.com",
          projectId: "speseviaggio",
          storageBucket: "speseviaggio.firebasestorage.app",
          messagingSenderId: "860769390246",
          appId: "1:860769390246:web:9fac090b0da7a5e1e6ae67"
        };

        // Variabili per l'istanza di Firebase
        let db;
        let auth;
        let currentUserId = null;
        let firebaseReady = false;
        let currentPasswordCallback = null; // Callback per la conferma password

        let knownParticipants = []; // Lista globale dei partecipanti conosciuti
        let allExpensesData = []; // Cache globale per tutte le spese
        let allIncomesData = []; // Cache globale per tutte le entrate

        // Funzione per mostrare/nascondere le viste
        function showView(viewId) {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('add-expense-form-container').classList.add('hidden');
            document.getElementById('view-expenses-list-container').classList.add('hidden');
            document.getElementById('income-management-container').classList.add('hidden');
            document.getElementById('view-single-participant-expenses-container').classList.add('hidden'); // Nascondi la nuova vista

            document.getElementById(viewId).classList.remove('hidden');

            // Aggiorna le viste quando vengono mostrate
            if (viewId === 'view-expenses-list-container') {
                // Questi saranno aggiornati tramite i listener onSnapshot, ma li chiamo per sicurezza
                // se la vista viene attivata senza un cambiamento nei dati sottostanti
                fetchAndDisplayExpenses();
                calculateAndDisplaySummary();
            } else if (viewId === 'income-management-container') {
                fetchKnownParticipants();
                fetchAndDisplayIncomes();
                calculateAndDisplayParticipantSummaryInIncomeSection();
                resetIncomeForm();
            } else if (viewId === 'add-expense-form-container') {
                renderExpenseParticipantsCheckboxes();
            } else if (viewId === 'view-single-participant-expenses-container') {
                populateSingleParticipantSelect(); // Popola il dropdown all'apertura
                document.getElementById('single-participant-select').value = ""; // Resetta la selezione
                document.getElementById('selected-participant-name').textContent = ""; // Pulisci il nome
                document.getElementById('total-single-participant-cost-display').classList.add('hidden');
                document.getElementById('single-participant-expenses-table-wrapper').classList.add('hidden');
                document.getElementById('no-single-expenses').classList.add('hidden');
                document.getElementById('loading-single-expenses').classList.add('hidden');
                // Nascondi il riepilogo del singolo partecipante all'inizio
                document.getElementById('single-participant-summary-section').classList.add('hidden');
            }
        }

        // --- Inizializzazione Firebase e Autenticazione ---
        async function initFirebase() {
            try {
                console.log("Configurazione Firebase usata:", firebaseConfig);

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Inizializza KNOWN_PARTICIPANTS_DOC_REF qui, dopo che 'db' è stato impostato
                KNOWN_PARTICIPANTS_DOC_REF = doc(db, `app_settings`, `known_participants`);

                // Setup listeners globali per i dati, così sono sempre aggiornati
                onSnapshot(collection(db, `public_travel_expenses`), (snapshot) => {
                    allExpensesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Trigger aggiornamenti per le viste attive
                    if (!document.getElementById('view-expenses-list-container').classList.contains('hidden')) {
                        fetchAndDisplayExpenses(); // Re-render table
                        calculateAndDisplaySummary(); // Re-calculate summary
                    }
                    if (!document.getElementById('income-management-container').classList.contains('hidden')) {
                        calculateAndDisplayParticipantSummaryInIncomeSection(); // Re-calculate income section summary
                    }
                    if (!document.getElementById('view-single-participant-expenses-container').classList.contains('hidden')) {
                        const selectedParticipant = document.getElementById('single-participant-select').value;
                        if (selectedParticipant) {
                            displaySingleParticipantExpenses(selectedParticipant);
                        }
                    }
                });

                onSnapshot(collection(db, `public_incomes`), (snapshot) => {
                    allIncomesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Trigger aggiornamenti per le viste attive
                    if (!document.getElementById('view-expenses-list-container').classList.contains('hidden')) {
                        calculateAndDisplaySummary();
                    }
                    if (!document.getElementById('income-management-container').classList.contains('hidden')) {
                        calculateAndDisplayParticipantSummaryInIncomeSection();
                        fetchAndDisplayIncomes(); // Re-render incomes list
                    }
                    if (!document.getElementById('view-single-participant-expenses-container').classList.contains('hidden')) {
                        const selectedParticipant = document.getElementById('single-participant-select').value;
                        if (selectedParticipant) {
                            displaySingleParticipantExpenses(selectedParticipant);
                        }
                    }
                });


                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('actual-user-id').textContent = currentUserId;
                        document.getElementById('user-id-display').classList.remove('hidden');
                        firebaseReady = true;
                        console.log("Firebase e autenticazione pronti. User ID:", currentUserId);
                    } else {
                        try {
                            await signInAnonymously(auth);
                            currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                        } catch (error) {
                            console.error("Errore durante l'autenticazione anonima:", error);
                            currentUserId = crypto.randomUUID();
                        } finally {
                            document.getElementById('actual-user-id').textContent = currentUserId;
                            document.getElementById('user-id-display').classList.remove('hidden');
                            firebaseReady = true;
                            console.log("Autenticazione completata (o fallback), User ID:", currentUserId);
                        }
                    }
                    // Abilita i pulsanti e nascondi il messaggio di caricamento una volta che Firebase è pronto
                    document.getElementById('initial-loading-message').classList.add('hidden');
                    document.getElementById('add-expense-btn').disabled = false;
                    document.getElementById('view-expenses-btn').disabled = false;
                    document.getElementById('add-income-btn').disabled = false;
                    document.getElementById('view-single-participant-expenses-btn').disabled = false; // Abilita il nuovo pulsante
                    console.log("Pulsanti abilitati e messaggio di caricamento nascosto."); // Log di conferma
                    showView('main-screen'); // Mostra esplicitamente la schermata principale
                });
            } catch (error) {
                console.error("Errore durante l'inizializzazione di Firebase (catch esterno):", error);
                currentUserId = crypto.randomUUID();
                document.getElementById('actual-user-id').textContent = currentUserId;
                document.getElementById('user-id-display').classList.remove('hidden');
                firebaseReady = true;
                document.getElementById('initial-loading-message').classList.add('hidden');
                document.getElementById('add-expense-btn').disabled = false;
                document.getElementById('view-expenses-btn').disabled = false;
                document.getElementById('add-income-btn').disabled = false;
                document.getElementById('view-single-participant-expenses-btn').disabled = false; // Abilita il nuovo pulsante
                console.log("Pulsanti abilitati in caso di errore di inizializzazione."); // Log di conferma
                showView('main-screen'); // Mostra esplicitamente la schermata principale
            }
        }

        // --- Gestione Modale Password (riutilizzata per delete, add expense, add income) ---
        const passwordModalOverlay = document.getElementById('password-modal-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const confirmPasswordBtn = document.getElementById('confirm-password-btn');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const passwordModalMessage = document.getElementById('password-modal-message');

        function openPasswordModal(title, message, callback) {
            passwordModalTitle.textContent = title;
            passwordModalMessage.textContent = message; // Messaggio generico
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordModalOverlay.classList.remove('hidden');
            passwordInput.focus();
            currentPasswordCallback = callback;
        }

        confirmPasswordBtn.addEventListener('click', () => {
            if (passwordInput.value === 'admin') {
                passwordModalOverlay.classList.add('hidden');
                if (currentPasswordCallback) {
                    currentPasswordCallback(true);
                }
            } else {
                passwordError.textContent = 'Password errata. Riprova.';
                passwordError.classList.remove('hidden');
                if (currentPasswordCallback) {
                    currentPasswordCallback(false);
                }
            }
        });

        cancelPasswordBtn.addEventListener('click', () => {
            passwordModalOverlay.classList.add('hidden');
            if (currentPasswordCallback) {
                currentPasswordCallback(false);
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmPasswordBtn.click();
            }
        });

        // --- Gestione Modale Dettagli Personalizzato (per sostituire alert) ---
        const customDetailsModalOverlay = document.getElementById('custom-details-modal-overlay');
        const customDetailsModalTitle = document.getElementById('custom-details-modal-title');
        const customDetailsModalContent = document.getElementById('custom-details-modal-content');
        const closeCustomDetailsModalBtn = document.getElementById('close-custom-details-modal-btn');

        function openCustomDetailsModal(title, content) {
            customDetailsModalTitle.textContent = title;
            customDetailsModalContent.textContent = content;
            customDetailsModalOverlay.classList.remove('hidden');
        }

        closeCustomDetailsModalBtn.addEventListener('click', () => {
            customDetailsModalOverlay.classList.add('hidden');
        });

        // --- Notification Pop-up ---
        const notificationPopup = document.getElementById('notification-popup');

        function showNotification(message, type = 'success') { // type can be 'success' or 'error'
            notificationPopup.textContent = message;
            notificationPopup.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white text-center text-lg font-semibold transition-opacity duration-500 ease-in-out z-[1001] show ${type}`;
            
            setTimeout(() => {
                notificationPopup.classList.remove('show');
                // Optionally hide completely after transition for accessibility
                setTimeout(() => {
                    notificationPopup.classList.add('hidden');
                }, 500); // Match CSS transition duration
            }, 2000); // Display for 2 seconds
        }


        // --- Gestione Partecipanti Conosciuti (Master List gestita implicitamente) ---
        // Riferimento al documento che memorizza i nomi dei partecipanti conosciuti
        let KNOWN_PARTICIPANTS_DOC_REF; // Dichiarata qui, inizializzata in initFirebase

        async function fetchKnownParticipants() {
            if (!db || !firebaseReady) {
                console.error("Firebase non pronto per recuperare i partecipanti conosciuti.");
                document.getElementById('loading-expense-participants').textContent = 'Errore: App non pronta per caricare i partecipanti.';
                document.getElementById('loading-expense-participants').classList.remove('hidden');
                document.getElementById('no-expense-participants').classList.add('hidden');
                return;
            }

            onSnapshot(KNOWN_PARTICIPANTS_DOC_REF, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    knownParticipants = docSnapshot.data().names || [];
                } else {
                    knownParticipants = [];
                }
                // Aggiorna i checkbox delle spese se la vista è attiva
                if (!document.getElementById('add-expense-form-container').classList.contains('hidden')) {
                    renderExpenseParticipantsCheckboxes();
                }
                // Aggiorna il riepilogo se la vista è attiva
                if (!document.getElementById('view-expenses-list-container').classList.contains('hidden')) {
                    calculateAndDisplaySummary();
                }
                // Aggiorna il riepilogo nella sezione entrate se la vista è attiva
                if (!document.getElementById('income-management-container').classList.contains('hidden')) {
                    calculateAndDisplayParticipantSummaryInIncomeSection();
                }
                // Aggiorna il dropdown delle spese singole
                if (!document.getElementById('view-single-participant-expenses-container').classList.contains('hidden')) {
                    populateSingleParticipantSelect();
                }

            }, (error) => {
                console.error("Errore nel recupero dei partecipanti conosciuti:", error);
                document.getElementById('loading-expense-participants').textContent = 'Errore nel caricamento dei partecipanti.';
                document.getElementById('loading-expense-participants').classList.remove('hidden');
                document.getElementById('no-expense-participants').classList.add('hidden');
            });
        }

        // Funzione per aggiungere un partecipante alla lista globale se non già presente
        async function addParticipantToKnownList(name) {
            if (!db || !firebaseReady) {
                console.error("Firebase non pronto per aggiungere il partecipante alla lista conosciuta.");
                return;
            }
            if (!knownParticipants.includes(name)) {
                try {
                    const updatedParticipants = [...knownParticipants, name];
                    await setDoc(KNOWN_PARTICIPANTS_DOC_REF, { names: updatedParticipants });
                    console.log(`Partecipante '${name}' aggiunto alla lista conosciuta.`);
                } catch (error) {
                    console.error(`Errore nell'aggiungere '${name}' alla lista conosciuta:`, error);
                }
            }
        }


        // --- Gestione Aggiungi/Modifica Spesa ---
        const expenseForm = document.getElementById('expense-form');
        const expenseFormTitle = document.getElementById('expense-form-title');
        const expenseIdToEdit = document.getElementById('expense-id-to-edit');
        const expenseDateInput = document.getElementById('expense-date');
        const expenseCostInput = document.getElementById('expense-cost');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseMessage = document.getElementById('expense-message');
        const submitExpenseBtn = document.getElementById('submit-expense-btn');
        const allParticipantsRadio = document.getElementById('all-participants-radio');
        const excludeParticipantsRadio = document.getElementById('exclude-participants-radio');
        const individualParticipantsSelectionDiv = document.getElementById('individual-participants-selection');
        const loadingExpenseParticipants = document.getElementById('loading-expense-participants');
        const noExpenseParticipants = document.getElementById('no-expense-participants');
        const addAnotherExpenseBtn = document.getElementById('add-another-expense-btn');

        // Event Listeners per i radio button
        allParticipantsRadio.addEventListener('change', () => {
            if (allParticipantsRadio.checked) {
                individualParticipantsSelectionDiv.classList.add('hidden');
                const checkboxes = individualParticipantsSelectionDiv.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    cb.disabled = true;
                });
            }
        });

        excludeParticipantsRadio.addEventListener('change', () => {
            if (excludeParticipantsRadio.checked) {
                individualParticipantsSelectionDiv.classList.remove('hidden');
                const checkboxes = individualParticipantsSelectionDiv.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.disabled = false;
                });
            }
        });


        function renderExpenseParticipantsCheckboxes(selectedForExpense = []) {
            individualParticipantsSelectionDiv.innerHTML = '';
            loadingExpenseParticipants.classList.remove('hidden');
            noExpenseParticipants.classList.add('hidden');
            individualParticipantsSelectionDiv.appendChild(loadingExpenseParticipants);

            allParticipantsRadio.disabled = false;
            excludeParticipantsRadio.disabled = false;

            if (!firebaseReady) {
                return;
            }

            if (knownParticipants.length === 0) {
                noExpenseParticipants.classList.remove('hidden');
                individualParticipantsSelectionDiv.appendChild(noExpenseParticipants);
                loadingExpenseParticipants.classList.add('hidden');
                allParticipantsRadio.checked = true;
                individualParticipantsSelectionDiv.classList.add('hidden');
            } else {
                noExpenseParticipants.classList.add('hidden');
                loadingExpenseParticipants.classList.add('hidden');
                
                knownParticipants.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'participant-checkbox-item';
                    const isChecked = selectedForExpense.length === 0 || selectedForExpense.includes(name);
                    div.innerHTML = `
                        <input type="checkbox" id="exp-part-${name.replace(/\s/g, '-')}" name="expenseParticipant" value="${name}" ${isChecked ? 'checked' : ''}>
                        <label for="exp-part-${name.replace(/\s/g, '-')}" class="text-gray-800 text-sm">${name}</label>
                    `;
                    individualParticipantsSelectionDiv.appendChild(div);
                });

                const checkboxes = individualParticipantsSelectionDiv.querySelectorAll('input[type="checkbox"]');
                if (selectedForExpense.length === 0 || selectedForExpense.length === knownParticipants.length) {
                    allParticipantsRadio.checked = true;
                    individualParticipantsSelectionDiv.classList.add('hidden');
                    checkboxes.forEach(cb => { cb.disabled = true; });
                } else {
                    excludeParticipantsRadio.checked = true;
                    individualParticipantsSelectionDiv.classList.remove('hidden');
                    checkboxes.forEach(cb => { cb.disabled = false; });
                }
            }
        }

        document.getElementById('add-expense-btn').addEventListener('click', () => {
            openPasswordModal(
                'Inserisci Password',
                'Per inserire una nuova spesa, inserisci la password.',
                (confirmed) => {
                    if (confirmed) {
                        showView('add-expense-form-container');
                        expenseFormTitle.textContent = 'Aggiungi Nuova Spesa';
                        submitExpenseBtn.textContent = 'Aggiungi Spesa';
                        expenseIdToEdit.value = '';
                        expenseForm.reset();
                        allParticipantsRadio.checked = true;
                        expenseMessage.textContent = '';
                        renderExpenseParticipantsCheckboxes();
                    }
                }
            );
        });

        addAnotherExpenseBtn.addEventListener('click', () => {
            expenseFormTitle.textContent = 'Aggiungi Nuova Spesa';
            submitExpenseBtn.textContent = 'Aggiungi Spesa';
            expenseIdToEdit.value = '';
            expenseForm.reset();
            allParticipantsRadio.checked = true;
            expenseMessage.textContent = '';
            renderExpenseParticipantsCheckboxes();
        });

        async function editExpense(expenseId) {
            openPasswordModal(
                'Modifica Spesa',
                'Per modificare questa spesa, inserisci la password.',
                (confirmed) => {
                    if (confirmed) {
                        showView('add-expense-form-container');
                        expenseFormTitle.textContent = 'Modifica Spesa';
                        submitExpenseBtn.textContent = 'Salva Modifiche';
                        expenseIdToEdit.value = expenseId;

                        const expense = allExpensesData.find(e => e.id === expenseId);
                        if (expense) {
                            expenseDateInput.value = expense.date instanceof Timestamp ? expense.date.toDate().toISOString().split('T')[0] : expense.date;
                            expenseCostInput.value = Math.ceil(expense.cost);
                            expenseDescriptionInput.value = expense.description;
                            renderExpenseParticipantsCheckboxes(expense.includedParticipants || []);
                        }
                    }
                }
            );
        }

        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !firebaseReady) {
                expenseMessage.textContent = 'Errore: Applicazione non pronta. Riprova più tardi.';
                expenseMessage.className = 'message error';
                return;
            }

            const id = expenseIdToEdit.value;
            const date = expenseDateInput.value;
            const cost = Math.ceil(parseFloat(expenseCostInput.value));
            const description = expenseDescriptionInput.value.trim();

            if (!date || isNaN(cost) || cost <= 0 || !description) {
                expenseMessage.textContent = 'Per favore, compila tutti i campi e assicurati che il costo sia un numero positivo.';
                expenseMessage.className = 'message error';
                return;
            }

            let finalIncludedParticipants = [];
            if (allParticipantsRadio.checked) {
                finalIncludedParticipants = knownParticipants;
            } else if (excludeParticipantsRadio.checked) {
                finalIncludedParticipants = Array.from(individualParticipantsSelectionDiv.querySelectorAll('input[name="expenseParticipant"]:checked'))
                                            .map(checkbox => checkbox.value);
            }

            if (finalIncludedParticipants.length === 0 && knownParticipants.length > 0) {
                expenseMessage.textContent = 'Devi selezionare almeno un partecipante specifico per la spesa.';
                expenseMessage.className = 'message error';
                submitExpenseBtn.disabled = false;
                submitExpenseBtn.classList.remove('loading-button');
                submitExpenseBtn.textContent = id ? 'Salva Modifiche' : 'Aggiungi Spesa';
                return;
            }
            if (finalIncludedParticipants.length === 0 && knownParticipants.length === 0) {
                expenseMessage.textContent = 'Nessun partecipante selezionato. Aggiungi partecipanti tramite le entrate.';
                expenseMessage.className = 'message error';
                submitExpenseBtn.disabled = false;
                submitExpenseBtn.classList.remove('loading-button');
                submitExpenseBtn.textContent = id ? 'Salva Modifiche' : 'Aggiungi Spesa';
                return;
            }


            submitExpenseBtn.disabled = true;
            submitExpenseBtn.classList.add('loading-button');
            submitExpenseBtn.textContent = id ? 'Salvando...' : 'Aggiungendo...';
            expenseMessage.textContent = '';

            try {
                const expenseData = {
                    date: Timestamp.fromDate(new Date(date)),
                    cost: cost,
                    description: description,
                    includedParticipants: finalIncludedParticipants,
                    timestamp: Timestamp.now()
                };

                if (id) {
                    await setDoc(doc(db, `public_travel_expenses`, id), expenseData);
                    showNotification('Spesa modificata con successo!', 'success');
                } else {
                    await addDoc(collection(db, `public_travel_expenses`), expenseData);
                    showNotification('Poveri, ma felici di vivere', 'success'); // Messaggio personalizzato
                }
                // No reset here, let "Add another expense" button handle it
            } catch (error) {
                console.error("Errore nell'operazione spesa:", error);
                expenseMessage.textContent = `Errore durante l'operazione. Riprova. ${error.message}`;
                expenseMessage.className = 'message error';
            } finally {
                submitExpenseBtn.disabled = false;
                submitExpenseBtn.classList.remove('loading-button');
                submitExpenseBtn.textContent = id ? 'Salva Modifiche' : 'Aggiungi Spesa';
            }
        });

        // --- Gestione Visualizzazione Spese e Cancellazione ---
        const expensesTableBody = document.getElementById('expenses-table-body');
        const totalCostDisplayTop = document.getElementById('total-cost-display-top');
        const totalCostValueTop = document.getElementById('total-cost-value-top');
        const loadingExpenses = document.getElementById('loading-expenses');
        const noExpenses = document.getElementById('no-expenses');
        const expensesTableWrapper = document.getElementById('expenses-table-wrapper');
        const exportDataBtn = document.getElementById('export-data-btn');

        // Nuovo elemento per la differenza totale
        const overallDifferenceSection = document.getElementById('overall-difference-section');
        const overallBalanceValue = document.getElementById('overall-balance-value');
        const filterStartDateInput = document.getElementById('filter-date-start');
        const filterEndDateInput = document.getElementById('filter-date-end');
        const filterDescriptionInput = document.getElementById('filter-description-input');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');


        applyFiltersBtn.addEventListener('click', () => fetchAndDisplayExpenses());
        resetFiltersBtn.addEventListener('click', () => {
            filterStartDateInput.value = '';
            filterEndDateInput.value = '';
            filterDescriptionInput.value = '';
            fetchAndDisplayExpenses();
        });


        document.getElementById('view-expenses-btn').addEventListener('click', () => {
            showView('view-expenses-list-container');
        });

        async function handleDeleteExpense(expenseId) {
            openPasswordModal(
                'Conferma Cancellazione Spesa',
                'Per cancellare questa spesa, inserisci la password.',
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, `public_travel_expenses`, expenseId));
                            console.log("Spesa cancellata con successo:", expenseId);
                        } catch (error) {
                            console.error("Errore durante la cancellazione della spesa:", error);
                            // Potresti mostrare un messaggio di errore all'utente qui
                        }
                    } else {
                        console.log("Cancellazione annullata o password errata.");
                    }
                }
            );
        }

        function fetchAndDisplayExpenses() {
            if (!db || !currentUserId || !firebaseReady) {
                console.error("Firebase non pronto per recuperare le spese.");
                loadingExpenses.textContent = 'Errore: Applicazione non pronta per recuperare le spese.';
                loadingExpenses.classList.remove('hidden');
                noExpenses.classList.add('hidden');
                expensesTableWrapper.classList.add('hidden');
                totalCostDisplayTop.classList.add('hidden');
                return;
            }

            loadingExpenses.classList.remove('hidden');
            noExpenses.classList.add('hidden');
            expensesTableWrapper.classList.add('hidden');
            totalCostDisplayTop.classList.add('hidden');
            expensesTableBody.innerHTML = '';

            let expensesToDisplay = [...allExpensesData];

            // Apply filters
            const filterStartDate = filterStartDateInput.value;
            const filterEndDate = filterEndDateInput.value;
            const filterDescription = filterDescriptionInput.value.toLowerCase();

            if (filterStartDate) {
                const start = new Date(filterStartDate);
                expensesToDisplay = expensesToDisplay.filter(expense => {
                    const expenseDate = expense.date instanceof Timestamp ? expense.date.toDate() : new Date(expense.date);
                    return expenseDate >= start;
                });
            }
            if (filterEndDate) {
                const end = new Date(filterEndDate);
                end.setHours(23, 59, 59, 999); // Include the whole end day
                expensesToDisplay = expensesToDisplay.filter(expense => {
                    const expenseDate = expense.date instanceof Timestamp ? expense.date.toDate() : new Date(expense.date);
                    return expenseDate <= end;
                });
            }
            if (filterDescription) {
                expensesToDisplay = expensesToDisplay.filter(expense =>
                    expense.description.toLowerCase().includes(filterDescription)
                );
            }


            expensesToDisplay.sort((a, b) => {
                const dateA = a.date instanceof Timestamp ? a.date.toDate() : new Date(a.date);
                const dateB = b.timestamp instanceof Timestamp ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB.getTime() - dateA.getTime();
            });

            expensesTableBody.innerHTML = '';
            let totalOverallCost = 0;

            if (expensesToDisplay.length === 0) {
                noExpenses.classList.remove('hidden');
                expensesTableWrapper.classList.add('hidden');
                totalCostDisplayTop.classList.add('hidden');
            } else {
                noExpenses.classList.add('hidden');
                expensesTableWrapper.classList.remove('hidden');
                totalCostDisplayTop.classList.remove('hidden');

                expensesToDisplay.forEach(expense => {
                    const row = expensesTableBody.insertRow();
                    const dateCell = row.insertCell();
                    const costCell = row.insertCell();
                    const descriptionCell = row.insertCell();
                    const participantsCell = row.insertCell(); // Nuova cella per i partecipanti
                    const actionCell = row.insertCell();

                    const displayDate = expense.date instanceof Timestamp ? expense.date.toDate().toLocaleDateString('it-IT') : new Date(expense.date).toLocaleDateString('it-IT');
                    const participantsList = expense.includedParticipants && expense.includedParticipants.length > 0
                                                ? expense.includedParticipants.join(', ')
                                                : 'Nessuno';

                    const maxChars = 25;
                    const truncatedParticipantsList = participantsList.length > maxChars
                            ? participantsList.substring(0, maxChars - 3) + '...'
                            : participantsList;

                    dateCell.textContent = displayDate;
                    costCell.textContent = Math.ceil(expense.cost).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    descriptionCell.textContent = expense.description;
                    participantsCell.textContent = truncatedParticipantsList;

                    if (participantsList.length > maxChars) {
                        participantsCell.classList.add('cursor-pointer', 'underline');
                        participantsCell.title = 'Clicca per vedere tutti i partecipanti';
                        participantsCell.addEventListener('click', () => {
                            openCustomDetailsModal('Partecipanti Spesa', `Partecipanti: ${participantsList}`);
                        });
                    }

                    const editIcon = document.createElement('i');
                    editIcon.className = 'fas fa-pencil-alt edit-icon';
                    editIcon.title = 'Modifica spesa';
                    editIcon.addEventListener('click', () => editExpense(expense.id));
                    actionCell.appendChild(editIcon);

                    const deleteIcon = document.createElement('i');
                    deleteIcon.className = 'fas fa-trash-alt delete-icon';
                    deleteIcon.title = 'Cancella spesa';
                    deleteIcon.addEventListener('click', () => handleDeleteExpense(expense.id));
                    actionCell.appendChild(deleteIcon);

                    dateCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900";
                    costCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                    descriptionCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                    participantsCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                    actionCell.className = "px-6 py-4 whitespace-nowrap text-right text-sm font-medium";

                    totalOverallCost += expense.cost;
                });
                totalCostValueTop.textContent = Math.ceil(totalOverallCost).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            loadingExpenses.classList.add('hidden');
        }

        // Funzione per esportare i dati in CSV
        exportDataBtn.addEventListener('click', exportDataToCSV);

        function exportDataToCSV() {
            if (!allExpensesData.length && !allIncomesData.length) {
                openCustomDetailsModal('Esporta Dati', "Non ci sono dati da esportare.");
                return;
            }

            let csvContent = "";

            // Intestazione Spese
            csvContent += "SPESE\n";
            csvContent += "Data;Costo (LKR);Descrizione;Partecipanti\n";
            allExpensesData.forEach(expense => {
                const date = expense.date instanceof Timestamp ? expense.date.toDate().toLocaleDateString('it-IT') : new Date(expense.date).toLocaleDateString('it-IT');
                const cost = Math.ceil(expense.cost).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                const description = `"${expense.description.replace(/"/g, '""')}"`; // Escape quotes
                const participants = `"${(expense.includedParticipants && expense.includedParticipants.length > 0 ? expense.includedParticipants.join(', ') : 'Nessuno').replace(/"/g, '""')}"`;
                csvContent += `${date};${cost};${description};${participants}\n`;
            });
            csvContent += "\n\n";

            // Intestazione Entrate
            csvContent += "ENTRATE\n";
            csvContent += "Data;Importo (LKR);Partecipante;Descrizione\n";
            allIncomesData.forEach(income => {
                const date = income.timestamp instanceof Timestamp ? income.timestamp.toDate().toLocaleDateString('it-IT') : new Date(income.timestamp).toLocaleDateString('it-IT');
                const amount = Math.ceil(income.amount).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                const participantName = `"${(income.participantName || 'Sconosciuto').replace(/"/g, '""')}"`;
                const description = `"${(income.description || 'Nessuna descrizione').replace(/"/g, '""')}"`;
                csvContent += `${date};${amount};${participantName};${description}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'dati_viaggio.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Dati esportati con successo!', 'success');
            } else {
                openCustomDetailsModal('Esporta Dati', "Il tuo browser non supporta il download diretto di file CSV.");
            }
        }


        // --- Gestione Entrate ---
        const addIncomeBtn = document.getElementById('add-income-btn');
        const incomeParticipantNameInput = document.getElementById('income-participant-name'); // Renamed ID
        const incomeAmountInput = document.getElementById('income-amount'); // Renamed ID
        const incomeDescriptionInput = document.getElementById('income-description');
        const saveSingleIncomeBtn = document.getElementById('save-single-income-btn'); // Renamed ID
        const incomeMessage = document.getElementById('income-message');
        const incomesTableBody = document.getElementById('incomes-table-body');
        const loadingIncomesRow = document.getElementById('loading-incomes-row');
        const noIncomesRow = document.getElementById('no-incomes-row');
        const deleteAllDataBtn = document.getElementById('delete-all-data-btn'); // Nuovo pulsante

        // Nuovi elementi per il riepilogo partecipanti nella sezione entrate
        const incomeSummaryTableBody = document.getElementById('income-summary-table-body');
        const loadingIncomeSummary = document.getElementById('loading-income-summary');
        const noIncomeSummaryData = document.getElementById('no-income-summary-data');
        const incomeSummaryTableWrapper = document.getElementById('income-summary-table-wrapper');
        const totalIncomeSectionDisplay = document.getElementById('total-income-section-display');
        const totalIncomeSectionValue = document.getElementById('total-income-section-value');


        addIncomeBtn.addEventListener('click', () => {
            openPasswordModal(
                'Inserisci Password',
                'Per gestire le entrate, inserisci la password.',
                (confirmed) => {
                    if (confirmed) {
                        showView('income-management-container');
                        resetIncomeForm(); // Resetta il form quando si accede alla sezione entrate
                    }
                }
            );
        });

        // Modificato per salvare una singola entrata direttamente
        document.getElementById('income-entry-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !firebaseReady) {
                incomeMessage.textContent = 'Errore: Applicazione non pronta. Riprova più tardi.';
                incomeMessage.className = 'message error';
                return;
            }

            const name = incomeParticipantNameInput.value.trim();
            const amount = Math.ceil(parseFloat(incomeAmountInput.value)); // Arrotonda per eccesso
            const description = incomeDescriptionInput.value.trim();

            if (!name || isNaN(amount) || amount <= 0) {
                incomeMessage.textContent = 'Per favorere, inserisci un nome e un importo valido per il partecipante.';
                incomeMessage.className = 'message error';
                return;
            }

            saveSingleIncomeBtn.disabled = true;
            saveSingleIncomeBtn.classList.add('loading-button');
            saveSingleIncomeBtn.textContent = 'Salvando...';
            incomeMessage.textContent = '';

            try {
                // Salva l'entrata come un singolo documento
                await addDoc(collection(db, `public_incomes`), {
                    timestamp: Timestamp.now(),
                    description: description || 'Nessuna descrizione',
                    // Salva il singolo partecipante e importo direttamente
                    participantName: name,
                    amount: amount
                });
                showNotification('Siamo più ricchi di prima', 'success'); // Messaggio personalizzato
                resetIncomeForm(); // Resetta il form
                fetchAndDisplayIncomes(); // Aggiorna la lista delle entrate
                addParticipantToKnownList(name); // Aggiungi il partecipante alla lista globale se nuovo

            }
            catch (error) {
                console.error("Errore nel salvare l'entrata:", error);
                incomeMessage.textContent = 'Errore durante il salvataggio dell\'entrata. Riprova.';
                incomeMessage.className = 'message error';
            } finally {
                saveSingleIncomeBtn.disabled = false;
                saveSingleIncomeBtn.classList.remove('loading-button');
                saveSingleIncomeBtn.textContent = 'Salva Entrata';
            }
        });

        async function handleDeleteIncome(incomeId) {
            openPasswordModal(
                'Conferma Cancellazione Entrata',
                'Per cancellare questa entrata, inserisci la password.',
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, `public_incomes`, incomeId));
                            console.log("Entrata cancellata con successo:", incomeId);
                        } catch (error) {
                            console.error("Errore durante la cancellazione dell'entrata:", error);
                        }
                    } else {
                        console.log("Cancellazione annullata o password errata.");
                    }
                }
            );
        }

        function resetIncomeForm() {
            incomeParticipantNameInput.value = '';
            incomeAmountInput.value = '';
            incomeDescriptionInput.value = '';
            incomeMessage.textContent = '';
            saveSingleIncomeBtn.disabled = false; // Assicurati che il pulsante non sia disabilitato dopo il reset
        }

        function fetchAndDisplayIncomes() {
            if (!db || !currentUserId || !firebaseReady) {
                console.error("Firebase non pronto per recuperare le entrate.");
                loadingIncomesRow.classList.remove('hidden');
                loadingIncomesRow.cells[0].textContent = 'Errore: Applicazione non pronta per recuperare le entrate.';
                noIncomesRow.classList.add('hidden');
                incomesTableBody.innerHTML = '';
                return;
            }

            loadingIncomesRow.classList.remove('hidden');
            loadingIncomesRow.cells[0].textContent = 'Caricamento entrate...';
            noIncomesRow.classList.add('hidden');
            incomesTableBody.innerHTML = '';

            const incomesCollectionRef = collection(db, `public_incomes`);
            const q = query(incomesCollectionRef);

            onSnapshot(q, (snapshot) => {
                let fetchedIncomes = [];
                snapshot.forEach(doc => {
                    fetchedIncomes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                fetchedIncomes.sort((a, b) => {
                    const dateA = a.timestamp instanceof Timestamp ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp instanceof Timestamp ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB.getTime() - dateA.getTime();
                });

                incomesTableBody.innerHTML = '';

                if (fetchedIncomes.length === 0) {
                    noIncomesRow.classList.remove('hidden');
                    loadingIncomesRow.classList.add('hidden');
                } else {
                    noIncomesRow.classList.add('hidden');
                    loadingIncomesRow.classList.add('hidden');

                    fetchedIncomes.forEach(income => {
                        const row = incomesTableBody.insertRow();
                        const dateCell = row.insertCell();
                        const totalCell = row.insertCell();
                        const descriptionCell = row.insertCell();
                        const actionCell = row.insertCell(); // Nuova cella per l'azione

                        const displayDate = income.timestamp instanceof Timestamp ? income.timestamp.toDate().toLocaleDateString('it-IT') : new Date(income.timestamp).toLocaleDateString('it-IT');

                        // Per le entrate singole, il "totale" è l'importo versato + nome partecipante
                        totalCell.textContent = `${Math.ceil(income.amount).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} LKR (${income.participantName})`; // Arrotonda e formatta
                        descriptionCell.textContent = income.description;
                        dateCell.textContent = displayDate;

                        const deleteIcon = document.createElement('i');
                        deleteIcon.className = 'fas fa-trash-alt delete-icon';
                        deleteIcon.title = 'Cancella entrata';
                        deleteIcon.addEventListener('click', () => handleDeleteIncome(income.id));
                        actionCell.appendChild(deleteIcon);

                        dateCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900";
                        totalCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                        descriptionCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                        actionCell.className = "px-6 py-4 whitespace-nowrap text-right text-sm font-medium";
                    });
                }
            }, (error) => {
                console.error("Errore nel recupero delle entrate:", error);
                loadingIncomesRow.classList.remove('hidden');
                loadingIncomesRow.cells[0].textContent = 'Errore nel caricamento delle entrate.';
                noIncomesRow.classList.add('hidden');
            });
        }

        // --- Calcolo e Visualizzazione Riepilogo Generale (in Vedi Totale Spese) ---
        const summaryTableBody = document.getElementById('summary-table-body');
        const loadingSummary = document.getElementById('loading-summary');
        const noSummaryData = document.getElementById('no-summary-data');
        const summaryTableWrapper = document.getElementById('summary-table-wrapper');
        const totalIncomeSummaryDisplay = document.getElementById('total-income-summary-display');
        const totalIncomeSummaryValue = document.getElementById('total-income-summary-value');

        async function calculateAndDisplaySummary() {
            if (!db || !firebaseReady) {
                console.error("Firebase non pronto per calcolare il riepilogo generale.");
                loadingSummary.textContent = 'Errore: Applicazione non pronta per il riepilogo.';
                loadingSummary.classList.remove('hidden');
                noSummaryData.classList.add('hidden');
                summaryTableWrapper.classList.add('hidden');
                totalIncomeSummaryDisplay.classList.add('hidden');
                overallDifferenceSection.classList.add('hidden'); // Nascondi anche questa sezione
                return;
            }

            loadingSummary.classList.remove('hidden');
            noSummaryData.classList.add('hidden');
            summaryTableWrapper.classList.add('hidden');
            totalIncomeSummaryDisplay.classList.add('hidden');
            overallDifferenceSection.classList.add('hidden'); // Nascondi all'inizio del calcolo
            summaryTableBody.innerHTML = '';

            try {
                // 1. Recupera tutti i dati necessari
                // Usa allExpensesData e allIncomesData che sono già aggiornati dai listener onSnapshot
                const allExpenses = [...allExpensesData];
                const allIncomes = [...allIncomesData];
                const knownParticipantsDoc = await getDoc(KNOWN_PARTICIPANTS_DOC_REF);
                const currentKnownParticipants = knownParticipantsDoc.exists() ? knownParticipantsDoc.data().names : [];

                // 2. Inizializza il riepilogo per ogni partecipante conosciuto
                const participantSummary = {};
                currentKnownParticipants.forEach(name => {
                    participantSummary[name] = { income: 0, expense: 0, balance: 0 };
                });

                let totalOverallIncome = 0;
                let totalOverallExpenses = 0; // Nuovo: per la somma totale delle spese

                // 3. Calcola le entrate per ogni partecipante
                allIncomes.forEach(income => {
                    totalOverallIncome += income.amount; // Usa income.amount per le entrate singole
                    if (participantSummary[income.participantName]) {
                        participantSummary[income.participantName].income += income.amount;
                    } else {
                        // Se l'entrata ha un partecipante non conosciuto, aggiungilo al riepilogo
                        participantSummary[income.participantName] = participantSummary[income.participantName] || { income: 0, expense: 0, balance: 0 };
                        participantSummary[income.participantName].income += income.amount;
                    }
                });

                // 4. Calcola le spese per ogni partecipante
                allExpenses.forEach(expense => {
                    totalOverallExpenses += expense.cost; // Aggiungi al totale generale delle spese

                    const includedForThisExpense = expense.includedParticipants && Array.isArray(expense.includedParticipants) && expense.includedParticipants.length > 0
                        ? expense.includedParticipants
                        : currentKnownParticipants; // Se non specificato, tutti i partecipanti conosciuti

                    if (includedForThisExpense.length > 0) {
                        const costPerPerson = expense.cost / includedForThisExpense.length;
                        includedForThisExpense.forEach(pName => {
                            if (participantSummary[pName]) { // Solo se il partecipante è nella lista conosciuta
                                participantSummary[pName].expense += costPerPerson;
                            } else {
                                // Se la spesa ha un partecipante non conosciuto, aggiungilo al riepilogo
                                participantSummary[pName] = participantSummary[pName] || { income: 0, expense: 0, balance: 0 };
                                participantSummary[pName].expense += costPerPerson;
                            }
                        });
                    }
                });

                // Calcola la differenza totale finale
                const finalOverallDifference = totalOverallIncome - totalOverallExpenses;

                // 5. Calcola la differenza e renderizza la tabella di riepilogo
                summaryTableBody.innerHTML = '';
                let hasSummaryData = false;
                // Ordina i partecipanti per nome per una visualizzazione consistente
                const sortedParticipantNames = Object.keys(participantSummary).sort();

                sortedParticipantNames.forEach(name => {
                    hasSummaryData = true;
                    const data = participantSummary[name];
                    data.balance = data.income - data.expense;

                    const row = summaryTableBody.insertRow();
                    const nameCell = row.insertCell();
                    const incomeCell = row.insertCell();
                    const expenseCell = row.insertCell();
                    const balanceCell = row.insertCell();

                    nameCell.textContent = name;
                    incomeCell.textContent = Math.ceil(data.income).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                    expenseCell.textContent = Math.ceil(data.expense).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                    balanceCell.textContent = Math.ceil(data.balance).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta

                    balanceCell.classList.add(data.balance >= 0 ? 'summary-positive' : 'summary-negative');
                    balanceCell.classList.add('font-semibold');

                    nameCell.className = "px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900";
                    incomeCell.className = "px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right";
                    expenseCell.className = "px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right";
                    balanceCell.className = "px-3 py-2 whitespace-nowrap text-sm text-right";
                });


                if (hasSummaryData) {
                    summaryTableWrapper.classList.remove('hidden');
                    totalIncomeSummaryDisplay.classList.remove('hidden');
                    totalIncomeSummaryValue.textContent = Math.ceil(totalOverallIncome).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                    noSummaryData.classList.add('hidden');
                } else {
                    summaryTableWrapper.classList.add('hidden');
                    totalIncomeSummaryDisplay.classList.add('hidden');
                    noSummaryData.classList.remove('hidden');
                }

                loadingSummary.classList.add('hidden');

                // Visualizza la differenza totale finale
                overallDifferenceSection.classList.remove('hidden');
                overallBalanceValue.textContent = Math.ceil(finalOverallDifference).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                overallDifferenceSection.classList.remove('bg-blue-50', 'bg-red-50', 'bg-green-50'); // Rimuovi classi precedenti
                
                // Rimuovi classi di testo precedenti
                overallBalanceValue.classList.remove('overall-balance-text-positive', 'overall-balance-text-negative', 'overall-balance-text-zero');
                overallBalanceValue.classList.add('font-bold'); // Assicurati che sia sempre bold

                if (finalOverallDifference > 0) {
                    overallDifferenceSection.classList.add('bg-green-50');
                    overallBalanceValue.classList.add('overall-balance-text-positive'); // Applica colore testo
                } else if (finalOverallDifference < 0) {
                    overallDifferenceSection.classList.add('bg-red-50');
                    overallBalanceValue.classList.add('overall-balance-text-negative'); // Applica colore testo
                } else {
                    overallDifferenceSection.classList.add('bg-blue-50'); // Neutro se zero
                    overallBalanceValue.classList.add('overall-balance-text-zero'); // Applica colore testo
                }


            } catch (error) {
                console.error("Errore nel calcolo o visualizzazione del riepilogo generale:", error);
                loadingSummary.textContent = 'Errore nel calcolo del riepilogo.';
                loadingSummary.classList.remove('hidden');
                noSummaryData.classList.remove('hidden');
                summaryTableWrapper.classList.add('hidden');
                totalIncomeSummaryDisplay.classList.add('hidden');
                overallDifferenceSection.classList.add('hidden');
            }
        }

        // --- Calcolo e Visualizzazione Riepilogo Partecipanti nella sezione Entrate ---
        async function calculateAndDisplayParticipantSummaryInIncomeSection() {
            if (!db || !firebaseReady) {
                console.error("Firebase non pronto per calcolare il riepilogo nella sezione entrate.");
                loadingIncomeSummary.textContent = 'Errore: Applicazione non pronta per il riepilogo.';
                loadingIncomeSummary.classList.remove('hidden');
                noIncomeSummaryData.classList.add('hidden');
                incomeSummaryTableWrapper.classList.add('hidden');
                totalIncomeSectionDisplay.classList.add('hidden');
                return;
            }

            loadingIncomeSummary.classList.remove('hidden');
            noIncomeSummaryData.classList.add('hidden');
            incomeSummaryTableWrapper.classList.add('hidden');
            totalIncomeSectionDisplay.classList.add('hidden');
            incomeSummaryTableBody.innerHTML = '';

            try {
                // 1. Recupera tutti i dati necessari
                // Usa allExpensesData e allIncomesData che sono già aggiornati dai listener onSnapshot
                const allExpenses = [...allExpensesData];
                const allIncomes = [...allIncomesData];
                const knownParticipantsDoc = await getDoc(KNOWN_PARTICIPANTS_DOC_REF);

                const currentKnownParticipants = knownParticipantsDoc.exists() ? knownParticipantsDoc.data().names : [];

                // 2. Inizializza il riepilogo per ogni partecipante conosciuto
                const participantSummary = {};
                currentKnownParticipants.forEach(name => {
                    participantSummary[name] = { income: 0, expense: 0, balance: 0 };
                });

                let totalOverallIncome = 0;

                // 3. Calcola le entrate per ogni partecipante
                allIncomes.forEach(income => {
                    totalOverallIncome += income.amount; // Usa income.amount per le entrate singole
                    participantSummary[income.participantName] = participantSummary[income.participantName] || { income: 0, expense: 0, balance: 0 };
                    participantSummary[income.participantName].income += income.amount;
                });

                // 4. Calcola le spese per ogni partecipante
                allExpenses.forEach(expense => {
                    const includedForThisExpense = expense.includedParticipants && Array.isArray(expense.includedParticipants) && expense.includedParticipants.length > 0
                        ? expense.includedParticipants
                        : currentKnownParticipants;

                    if (includedForThisExpense.length > 0) {
                        const costPerPerson = expense.cost / includedForThisExpense.length;
                        includedForThisExpense.forEach(pName => {
                            participantSummary[pName] = participantSummary[pName] || { income: 0, expense: 0, balance: 0 };
                            participantSummary[pName].expense += costPerPerson;
                        });
                    }
                });

                // 5. Calcola la differenza e renderizza la tabella di riepilogo
                incomeSummaryTableBody.innerHTML = '';
                let hasSummaryData = false;
                const sortedParticipantNames = Object.keys(participantSummary).sort();

                sortedParticipantNames.forEach(name => {
                    hasSummaryData = true;
                    const data = participantSummary[name];
                    // data.balance = data.income - data.expense; // Non calcoliamo la differenza qui, solo entrate

                    const row = incomeSummaryTableBody.insertRow();
                    const nameCell = row.insertCell();
                    const incomeCell = row.insertCell();
                    // Rimosse le celle per Spese e Differenza, come da richiesta
                    // const expenseCell = row.insertCell();
                    // const balanceCell = row.insertCell();

                    nameCell.textContent = name;
                    incomeCell.textContent = Math.ceil(data.income).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                    // expenseCell.textContent = '0'; // Non mostriamo le spese qui
                    // balanceCell.textContent = '0'; // Non mostriamo la differenza qui

                    // Rimuovi classi di colore e grassetto per Entrate/Spese/Differenza
                    incomeCell.classList.remove('summary-positive', 'summary-negative', 'font-semibold');
                    // expenseCell.classList.remove('summary-positive', 'summary-negative', 'font-semibold');
                    // balanceCell.classList.remove('summary-positive', 'summary-negative', 'font-semibold');

                    nameCell.className = "px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900";
                    incomeCell.className = "px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right";
                    // expenseCell.className = "px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right";
                    // balanceCell.className = "px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right";
                });


                if (hasSummaryData) {
                    incomeSummaryTableWrapper.classList.remove('hidden');
                    totalIncomeSectionDisplay.classList.remove('hidden');
                    totalIncomeSectionValue.textContent = Math.ceil(totalOverallIncome).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); // Arrotonda e formatta
                    noIncomeSummaryData.classList.add('hidden');
                } else {
                    incomeSummaryTableWrapper.classList.add('hidden');
                    totalIncomeSectionDisplay.classList.add('hidden');
                    noIncomeSummaryData.classList.remove('hidden');
                }

                loadingIncomeSummary.classList.add('hidden');

            } catch (error) {
                console.error("Errore nel calcolo o visualizzazione del riepilogo nella sezione entrate:", error);
                loadingIncomeSummary.textContent = 'Errore nel calcolo del riepilogo.';
                loadingIncomeSummary.classList.remove('hidden');
                noIncomeSummaryData.classList.remove('hidden');
                incomeSummaryTableWrapper.classList.add('hidden');
                totalIncomeSectionDisplay.classList.add('hidden');
            }
        }

        // --- Gestione Cancellazione Tutti i Dati ---
        deleteAllDataBtn.addEventListener('click', () => {
            openPasswordModal(
                'Conferma Cancellazione Completa',
                'ATTENZIONE: Questa operazione cancellerà TUTTE le spese, entrate e i partecipanti. Inserisci la password per confermare.',
                async (confirmed) => {
                    if (confirmed) {
                        try {
                            const collectionsToDelete = ['public_travel_expenses', 'public_incomes'];
                            // Per i partecipanti conosciuti, cancelliamo il documento specifico
                            await deleteDoc(KNOWN_PARTICIPANTS_DOC_REF);
                            console.log("Documento partecipanti conosciuti cancellato.");

                            for (const collectionName of collectionsToDelete) {
                                const q = query(collection(db, collectionName));
                                const snapshot = await getDocs(q);
                                if (snapshot.empty) {
                                    console.log(`Nessun documento da cancellare in ${collectionName}.`);
                                    continue;
                                }
                                const deletePromises = snapshot.docs.map(d => deleteDoc(doc(db, collectionName, d.id)));
                                await Promise.all(deletePromises);
                                console.log(`Tutti i documenti in ${collectionName} cancellati.`);
                            }
                            openCustomDetailsModal('Dati Cancellati', 'Tutti i dati sono stati cancellati con successo!');
                            showView('main-screen'); // Torna alla schermata principale
                        } catch (error) {
                            console.error("Errore durante la cancellazione di tutti i dati:", error);
                            openCustomDetailsModal('Errore', 'Errore durante la cancellazione dei dati. Controlla la console per i dettagli.');
                        }
                    } else {
                        console.log("Cancellazione di tutti i dati annullata o password errata.");
                    }
                }
            );
        });

        // --- Funzione Vedi Spese Singole ---
        const viewSingleParticipantExpensesBtn = document.getElementById('view-single-participant-expenses-btn');
        const singleParticipantSelect = document.getElementById('single-participant-select');
        const selectedParticipantNameSpan = document.getElementById('selected-participant-name');
        const totalSingleParticipantCostDisplay = document.getElementById('total-single-participant-cost-display');
        const totalSingleParticipantCostValue = document.getElementById('total-single-participant-cost-value');
        const singleParticipantExpensesTableBody = document.getElementById('single-participant-expenses-table-body');
        const loadingSingleExpenses = document.getElementById('loading-single-expenses');
        const noSingleExpenses = document.getElementById('no-single-expenses');
        const singleParticipantExpensesTableWrapper = document.getElementById('single-participant-expenses-table-wrapper');

        // Nuovi elementi per il riepilogo singolo partecipante
        const singleParticipantSummarySection = document.getElementById('single-participant-summary-section');
        const singleParticipantSummaryName = document.getElementById('single-participant-summary-name');
        const singleParticipantIncomeValue = document.getElementById('single-participant-income-value');
        const singleParticipantExpenseValue = document.getElementById('single-participant-expense-value');
        const singleParticipantBalanceValue = document.getElementById('single-participant-balance-value');


        viewSingleParticipantExpensesBtn.addEventListener('click', () => {
            showView('view-single-participant-expenses-container');
        });

        singleParticipantSelect.addEventListener('change', (e) => {
            const selectedName = e.target.value;
            if (selectedName) {
                displaySingleParticipantExpenses(selectedName);
                calculateSingleParticipantSummary(selectedName); // Calcola e visualizza il riepilogo
            } else {
                // Se non è selezionato nessun partecipante, pulisci la tabella e il riepilogo
                selectedParticipantNameSpan.textContent = "";
                totalSingleParticipantCostDisplay.classList.add('hidden');
                singleParticipantExpensesTableWrapper.classList.add('hidden');
                noSingleExpenses.classList.add('hidden');
                loadingSingleExpenses.classList.add('hidden');
                singleParticipantExpensesTableBody.innerHTML = '';
                singleParticipantSummarySection.classList.add('hidden'); // Nascondi il riepilogo
            }
        });

        function populateSingleParticipantSelect() {
            singleParticipantSelect.innerHTML = '<option value="">-- Seleziona un partecipante --</option>';
            if (knownParticipants.length > 0) {
                knownParticipants.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    singleParticipantSelect.appendChild(option);
                });
            }
        }

        function displaySingleParticipantExpenses(participantName) {
            selectedParticipantNameSpan.textContent = participantName;
            loadingSingleExpenses.classList.remove('hidden');
            noSingleExpenses.classList.add('hidden');
            singleParticipantExpensesTableWrapper.classList.add('hidden');
            totalSingleParticipantCostDisplay.classList.add('hidden');
            singleParticipantExpensesTableBody.innerHTML = '';

            const filteredExpenses = allExpensesData.filter(expense =>
                expense.includedParticipants && expense.includedParticipants.includes(participantName)
            );

            filteredExpenses.sort((a, b) => {
                const dateA = a.date instanceof Timestamp ? a.date.toDate() : new Date(a.date);
                const dateB = b.timestamp instanceof Timestamp ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB.getTime() - dateA.getTime();
            });

            let totalParticipantExpense = 0;

            if (filteredExpenses.length === 0) {
                noSingleExpenses.classList.remove('hidden');
            } else {
                singleParticipantExpensesTableWrapper.classList.remove('hidden');
                totalSingleParticipantCostDisplay.classList.remove('hidden');
                filteredExpenses.forEach(expense => {
                    const row = singleParticipantExpensesTableBody.insertRow();
                    const dateCell = row.insertCell();
                    const totalCostCell = row.insertCell();
                    const quotaCell = row.insertCell();
                    const descriptionCell = row.insertCell();

                    const displayDate = expense.date instanceof Timestamp ? expense.date.toDate().toLocaleDateString('it-IT') : new Date(expense.date).toLocaleDateString('it-IT');
                    const quota = expense.includedParticipants.length > 0 ? expense.cost / expense.includedParticipants.length : 0;
                    totalParticipantExpense += quota;

                    dateCell.textContent = displayDate;
                    totalCostCell.textContent = Math.ceil(expense.cost).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    quotaCell.textContent = Math.ceil(quota).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    descriptionCell.textContent = expense.description;

                    dateCell.className = "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900";
                    totalCostCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                    quotaCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                    descriptionCell.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-500";
                });
                totalSingleParticipantCostValue.textContent = Math.ceil(totalParticipantExpense).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            loadingSingleExpenses.classList.add('hidden');
        }

        async function calculateSingleParticipantSummary(participantName) {
            singleParticipantSummarySection.classList.add('hidden'); // Nascondi all'inizio del calcolo
            singleParticipantSummaryName.textContent = participantName; // Imposta il nome nel riepilogo

            let incomeForParticipant = 0;
            let expenseForParticipant = 0;

            // Calcola entrate per il partecipante
            allIncomesData.forEach(income => {
                if (income.participantName === participantName) {
                    incomeForParticipant += income.amount;
                }
            });

            // Calcola spese per il partecipante
            allExpensesData.forEach(expense => {
                if (expense.includedParticipants && expense.includedParticipants.includes(participantName)) {
                    const quota = expense.includedParticipants.length > 0 ? expense.cost / expense.includedParticipants.length : 0;
                    expenseForParticipant += quota;
                }
            });

            const balance = incomeForParticipant - expenseForParticipant;

            singleParticipantIncomeValue.textContent = Math.ceil(incomeForParticipant).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            singleParticipantExpenseValue.textContent = Math.ceil(expenseForParticipant).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            singleParticipantBalanceValue.textContent = Math.ceil(balance).toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            // Applica la formattazione del colore al testo della differenza
            singleParticipantBalanceValue.classList.remove('overall-balance-text-positive', 'overall-balance-text-negative', 'overall-balance-text-zero');
            if (balance > 0) {
                singleParticipantBalanceValue.classList.add('overall-balance-text-positive');
            } else if (balance < 0) {
                singleParticipantBalanceValue.classList.add('overall-balance-text-negative');
            } else {
                singleParticipantBalanceValue.classList.add('overall-balance-text-zero');
            }

            // Applica la formattazione del colore di sfondo alla sezione
            singleParticipantSummarySection.classList.remove('bg-blue-50', 'bg-red-50', 'bg-green-50');
            if (balance > 0) {
                singleParticipantSummarySection.classList.add('bg-green-50');
            } else if (balance < 0) {
                singleParticipantSummarySection.classList.add('bg-red-50');
            } else {
                singleParticipantSummarySection.classList.add('bg-blue-50');
            }

            singleParticipantSummarySection.classList.remove('hidden'); // Mostra la sezione
        }


        // --- Pulsanti per tornare alla schermata principale ---
        document.getElementById('back-to-main-from-add').addEventListener('click', () => {
            showView('main-screen');
        });

        document.getElementById('back-to-main-from-view').addEventListener('click', () => {
            showView('main-screen');
        });

        document.getElementById('back-to-main-from-income').addEventListener('click', () => {
            showView('main-screen');
        });

        document.getElementById('back-to-main-from-single-expenses').addEventListener('click', () => {
            showView('main-screen');
        });

        // Inizializza Firebase all'apertura della pagina
        window.onload = () => {
            // Assicurati che il modale della password sia nascosto all'inizio
            document.getElementById('password-modal-overlay').classList.add('hidden');
            initFirebase();
        };
    </script>
</body>
</html>